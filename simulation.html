<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Philipp Broniecki and Lucas Leemann – Machine Learning 1K" />


<title>How to Simulate without Zelig</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/sandstone.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-1.1/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-1.1/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 61px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 66px;
  margin-top: -66px;
}

.section h2 {
  padding-top: 66px;
  margin-top: -66px;
}
.section h3 {
  padding-top: 66px;
  margin-top: -66px;
}
.section h4 {
  padding-top: 66px;
  margin-top: -66px;
}
.section h5 {
  padding-top: 66px;
  margin-top: -66px;
}
.section h6 {
  padding-top: 66px;
  margin-top: -66px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->






<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Essex 2017 Machine Learning</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Day 1
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="day1.html">Lab</a>
    </li>
    <li>
      <a href="./slides/D1%20-%20Intro%20ML.pdf">Slides</a>
    </li>
    <li>
      <a href="solutions1.html">Solutions</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Day 2
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="day2.html">Lab</a>
    </li>
    <li>
      <a href="./slides/D2%20-%20Intro%20ML.pdf">Slides</a>
    </li>
    <li>
      <a href="solutions2.html">Solutions</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Day 3
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="day3.html">Lab</a>
    </li>
    <li>
      <a href="./slides/D3%20-%20Classification.pdf">Slides</a>
    </li>
    <li>
      <a href="solutions3.html">Solutions</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Day 4
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="day4.html">Lab</a>
    </li>
    <li>
      <a href="./slides/D4%20-%20Resampling.pdf">Slides</a>
    </li>
    <li>
      <a href="solutions4.html">Solutions</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Day 5
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="day5.html">Lab</a>
    </li>
    <li>
      <a href="labs/Lab%20Code%205.R">plain R-Code</a>
    </li>
    <li>
      <a href="./slides/D5%20-%20Model%20Selection%20I.pdf">Slides</a>
    </li>
    <li>
      <a href="solutions5.html">Solutions</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Day 6
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="day6.html">Lab</a>
    </li>
    <li>
      <a href="./slides/D6%20-%20Model%20Selection%20II.pdf">Slides</a>
    </li>
    <li>
      <a href="solutions6.html">Solutions</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Day 7
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="day7.html">Lab</a>
    </li>
    <li>
      <a href="./slides/D7%20-%20Polynomial%20Models.pdf">Slides</a>
    </li>
    <li>
      <a href="solutions7.html">Solutions</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Day 8
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="day8.html">Lab</a>
    </li>
    <li>
      <a href="./slides/D8%20-%20Tree-Based%20Methods.pdf">Slides</a>
    </li>
    <li>
      <a href="solutions8.html">Solutions</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Day 9
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="day9.html">Lab</a>
    </li>
    <li>
      <a href="./slides/D9%20-%20Unsupervised%20Learning.pdf">Slides</a>
    </li>
    <li>
      <a href="solutions9.html">Solutions</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    More
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="simulation.html">Simulation</a>
    </li>
    <li>
      <a href="montecarlo.html">Monte Carlos</a>
    </li>
    <li>
      <a href="MCLassoRidge.html">MC Lasso v. Ridge</a>
    </li>
    <li>
      <a href="splinesCV.html">Splines Cross Validated</a>
    </li>
    <li>
      <a href="./data/titanic.dta">Titanic Data</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">How to Simulate without Zelig</h1>
<h4 class="author"><em>Philipp Broniecki and Lucas Leemann – Machine Learning 1K</em></h4>

</div>


<p>Simulation can be done in a few steps even without the Zelig package. If we make a prediction, we want to be able to quantify our uncertainty of that prediction. This makes it transparent how well we are able to predict.</p>
<p>Simulation is the Swiss army knife of statistics. Quantifying the uncertainty of an outcome can be tough or even impossible algebraically. Even for the linear model we need to consider the standard errors of all coefficients and their covariance. The formulas can be tedious…</p>
<p><strong>For simulation, the process is always the same regardless of the model.</strong></p>
<p>We start by loading data and fitting a linear model on the unemployment rate.</p>
<pre class="r"><code># clear workspace
rm(list=ls())
# load data
df &lt;- read.csv(&quot;http://philippbroniecki.github.io/ML2017.io/data/communities.csv&quot;)</code></pre>
<p><strong>Simulation step 1:</strong> Our coefficients each follow a sampling distribution. Jointly, they follow a multivariate distribution which is assumed to be multivariate normal.</p>
<p>To characterize the shape of the distribution we need to know its mean and its variance. The mean is our vector of coefficient point estimates. We extract it using <code>coef(model_name)</code>. The variance is the model uncertainty which lives in the variance-covariance matrix. We extract it with <code>vcov(model_name)</code>.</p>
<p>As we draw randomly from a distribution we want to set the random number generator with <code>set.seed()</code> to make our results replicable and we pick the number of coefficients to draw form the distribution (the number of simulations).</p>
<pre class="r"><code># run a model
m1 &lt;- lm(PctUnemployed ~ pctUrban + householdsize + racePctWhite, data = df)

# set the random number generator to some value
set.seed(123)

# pick how many coefficients you want to draw from the distribution
n.sim &lt;- 1000

# draw coefficients from the multivariate normal
S &lt;- MASS::mvrnorm(n.sim, coef(m1), vcov(m1))</code></pre>
<p><strong>Simulation step 2:</strong> Choose a scenario for which you want to make a prediction. That means we have to set our covariates to some value. We will vary the percentage of the urban population and keep all other covariates constant. We also check the range of the variable of interest so that we don’t extrapolate to something that is outside of our data range.</p>
<pre class="r"><code># choose a scenario to predict the outcome for
summary(df$pctUrban)</code></pre>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##  0.0000  0.0000  1.0000  0.6963  1.0000  1.0000</code></pre>
<pre class="r"><code># set the covariates (predictions for changes in pctUrban)
X &lt;- cbind( constant = 1,
            urban = seq(from = 0, to = 1, by = .1),
            householdsize = mean(df$householdsize),
            pctwhite = mean(df$racePctWhite))

# check covariates
X            </code></pre>
<pre><code>##       constant urban householdsize  pctwhite
##  [1,]        1   0.0     0.4633952 0.7537161
##  [2,]        1   0.1     0.4633952 0.7537161
##  [3,]        1   0.2     0.4633952 0.7537161
##  [4,]        1   0.3     0.4633952 0.7537161
##  [5,]        1   0.4     0.4633952 0.7537161
##  [6,]        1   0.5     0.4633952 0.7537161
##  [7,]        1   0.6     0.4633952 0.7537161
##  [8,]        1   0.7     0.4633952 0.7537161
##  [9,]        1   0.8     0.4633952 0.7537161
## [10,]        1   0.9     0.4633952 0.7537161
## [11,]        1   1.0     0.4633952 0.7537161</code></pre>
<p><strong>Simulation step 3:</strong> Predict the outcome. We have set our covariates and we have drawn our coefficients. This is all we need to predict <span class="math inline">\(y\)</span>. Depending on the flavour of generalized linear model, <span class="math inline">\(y\)</span> may have to be sent through a link function. In logistic regression we would send latent <span class="math inline">\(y\)</span> trough the logit link function: <span class="math inline">\(\frac{1}{1 + exp^{-y}}\)</span> to get probabilities that <span class="math inline">\(y\)</span> is 1. Here, we ran a simple linear model so in linear algebra notation our prediction is simply <span class="math inline">\(Y=X\beta\)</span>.</p>
<p>We estimate <code>y_hat</code> as a matrix where its rows are the number of simulations and its columns are the different covariate scenarios.</p>
<pre class="r"><code># predict outcome, ie betas * X for all scenarios
y_hat &lt;- S %*% t(as.matrix(X))</code></pre>
<p>Finally, all that is left is the interpretation of the result. We can simply look at the numerical outcomes similar to using the <code>summary()</code> function on the Zelig simulation object.</p>
<pre class="r"><code># output like the zelig summary (including estimation uncertainty)
apply(y_hat, 2, quantile, probs = c(.025, .5, .975))</code></pre>
<pre><code>##            [,1]      [,2]      [,3]      [,4]      [,5]      [,6]
## 2.5%  0.4316010 0.4214979 0.4105675 0.4000181 0.3893180 0.3784349
## 50%   0.4450405 0.4332109 0.4215157 0.4097547 0.3981805 0.3864607
## 97.5% 0.4584981 0.4454806 0.4327917 0.4198413 0.4070521 0.3945582
##            [,7]      [,8]      [,9]     [,10]     [,11]
## 2.5%  0.3672170 0.3557150 0.3439413 0.3318641 0.3196062
## 50%   0.3747705 0.3630690 0.3512949 0.3396307 0.3279723
## 97.5% 0.3823658 0.3703668 0.3586515 0.3473086 0.3363178</code></pre>
<p>We can also draw a plot that shows our mean prediction and the uncertainty around in a few lines.</p>
<pre class="r"><code># plot like zelig&#39;s ci plot
par( mfrow = c(1,1))
plot(0, bty = &quot;n&quot;, xlab = &quot;Pct Urban&quot;, ylab = &quot;Unemployment Rate&quot;, 
     ylim = c(0.3, 0.5), xlim = c(0,1), pch =&quot;&quot;)
ci &lt;- apply(y_hat, 2, quantile, probs = c(.025, .975))
polygon(x =  c(rev(X[,&quot;urban&quot;]), X[,&quot;urban&quot;]), 
        y = c(rev(t(ci)[,2]), t(ci)[,1]), border = NA,
        col = &quot;lightblue&quot;)
lines(x = X[,&quot;urban&quot;], y = apply(y_hat, 2, quantile, probs = .5), lwd = 1)</code></pre>
<p><img src="simulation_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
